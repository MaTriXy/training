<!DOCTYPE html>
<html>
  <head>
    <title>Android training - Security</title>
    <meta charset='utf-8'>
    <script src='../res/slides.js'></script>
  </head>
  <body style='display: none'>
    <section class='slides layout-regular template-default'>
    
<article>
<!-- ==================================================== -->

<h1>Security</h1>    

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Permissions</h3>
<ul>
  <li>each application runs with a distinct system identity (Linux user ID and group ID)</li>
  <li>no application, by default, has permission to perform any operations</li>
  <li>any other security features need to use "permission" mechanism
  <li>per-URI permissions</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Permissions</h3>
<ul>
  <li>Android sandboxes applications from each other</li>
  <li>If an application has to access data need to request a permission</li>
</ul>
<p><span class="red">"The application sandbox does not depend on the 
technology used to build an application. In particular the Dalvik VM is 
not a security boundary, and any app can run native code (see the Android NDK). 
All types of applications — Java, native, and hybrid — are sandboxed in the 
same way and have the same degree of security from each other."</span></p>
 
<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Creating your own permission</h3>
<p></p>
<pre><code>&lt;permission 
  android:name="com.me.app.myapp.permission.DEADLY_ACTIVITY"
  android:label="@string/permlab_deadlyActivity"
  android:description="@string/permdesc_deadlyActivity"
  android:permissionGroup="android.permission-group.COST_MONEY"
  android:protectionLevel="dangerous" /&gt;</code></pre>
  
<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>PermissionGroup</h3>
<ul>
  <li>ACCOUNTS : Permissions for direct access to the accounts managed by the Account Manager.</li>
  <li>COST_MONEY : Used for permissions that can be used to make the user spend money without their direct involvement.</li>
  <li>SYSTEM_TOOLS : Group of permissions that are related to system APIs</li>
</ul>
<p><a href="http://developer.android.com/reference/android/Manifest.permission_group.html">all the permission groups</a></p>
<pre><code>android.permission-group.ACCOUNTS</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>PermissionLevel</h3>
<ul>
  <li><span class="red">dangerous</span> : A higher-risk permission required approval from the user.</li>
  <li><span class="red">signatureOrSystem</span> : A permission that the system 
    grants only to applications that are in the Android system 
    image or that are signed with the same certificates as those 
    in the system image</li>
  <li><span class="red">signature</span> :  same signature of the app that requested the permission then no approval request</li>
  <li><span class="red">normal</span> : no approval requested during installation</li>
</ul>  
  
<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>How to use permission on content providers</h3>
<pre><code>&lt;provider 
  android:name=".SecuredContentProvider" 
  android:authorities="com.novoda.security" 
  android:exported="true"
  android:readPermission="com.novoda.tranining.READ" 
  android:writePermission="com.novoda.tranining.WRITE"/&gt;</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 1 : content provider between apps</h3>
<ul>
  <li>Create a content provider in a "provider app"... just logs the methods!</li>
  <li>In a "client app" call the query method</li>
  <li>Check that works</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 2 : block with permission</h3>
<ul>
  <li>Add custom read and write permissions</li>
  <li>Check that the "client application" is now crashing</li>
</ul>
<p><span class="red">Extra : play with insert/delete and write/read permission</span></p>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 2</h3>
<pre><code>&lt;permission android:name="com.novoda.tranining.READ"
  android:label="@string/permission_label"
  android:description="@string/permission_description"
  android:permissionGroup="android.permission-group.DEVELOPMENT_TOOLS"
  android:protectionLevel="dangerous" /&gt;
&lt;permission android:name="com.novoda.tranining.WRITE"
  android:label="@string/permission_label"
  android:description="@string/permission_description"
  android:permissionGroup="android.permission-group.DEVELOPMENT_TOOLS"
  android:protectionLevel="dangerous" /&gt;
</a></code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 2</h3>
<pre><code>&lt;provider 
  android:name=".SecuredContentProvider" 
  android:authorities="com.novoda.security" 
  android:exported="true"
  android:readPermission="com.novoda.tranining.READ" 
  android:writePermission="com.novoda.tranining.WRITE"
  /&gt;
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 3 : use your own permission</h3>
<ul>
  <li>Add permission to the client app and make it work</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 3</h3>
<pre><code>&lt;uses-permission android:name="com.novoda.tranining.READ"/&gt;
&lt;uses-permission android:name="com.novoda.tranining.WRITE"/&gt;
</code>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Activity</h3>
<br />
<p>Activity permissions restrict who can start the associated activity</p>
<br />
<p>checked during Context.startActivity()</p>
<br>
<pre><code>android:permission=""</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Service</h3>
<br />
<p>restrict who can start or bind to the associated service</p>
<br />
<p>The permission is checked during 
Context.startService(), Context.stopService() and Context.bindService();</p>
<br>
<pre><code>android:permission=""</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>BroadcastReceiver</h3>
<p>Restrict 
who can send broadcasts to the associated receiver</p>
<br />
<pre><code>registerReceiver(receiver, filter, broadcastPermission, scheduler)

sendBroadcast(intent, receiverPermission) 
</code></pre>
<br>
<pre><code>android:permission=""</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Uri permission</h3>
<br />
<p>There are special methods that can manipulate permissions</p>
<pre><code>Context.grantUriPermission()
Context.revokeUriPermission()
Context.checkUriPermission()</code></pre> 
<p>Example of gmail attachment</p>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>UserId</h3>
<br />
<p>Every app has a specific userId</p>
<br />
<p>You can use the same userId for different applications</p>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Setting application to use the same userId</h3>
<pre><code>&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.novoda.app2"
    android:versionCode="1"
    android:versionName="1.0" 
    android:sharedUserId="com.novoda.app1" &gt;
    &lt;uses-sdk android:minSdkVersion="14" /&gt;
    &lt;application
        android:icon="@drawable/ic_launcher"
        android:label="@string/app_name" 
        android:process="com.novoda.app1"&gt;
</code></pre>
<p>Do it in both the manifests</p>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 4</h3>
<ul>
  <li>create an app set a preference</li>
  <li>on a second app try to get the value of the preference</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 4</h3>
<br />
<pre><code>public class App1 extends Activity {
   @Override
   public void onCreate(Bundle savedInstanceState) {
      super.onCreate(savedInstanceState);
      setContentView(R.layout.main);
      SharedPreferences prefs = getSharedPreferences(
                                   "app1prefs", MODE_PRIVATE);
      String value = "Hello from App1 preference file!";
      prefs.edit().putString("shared_value", value).commit();
   }
   @Override
   public String toString() {
      return "Hello from App1 toString()!";
   }
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 4</h3>
<br />
<pre><code>try {
context1 = createPackageContext("com.novoda.app1",
		CONTEXT_INCLUDE_CODE);
Class&lt;?&gt; app1ActivityCls = context1.getClassLoader().loadClass(
			"com.novoda.app1.App1Activity");
	Object app1Activity = app1ActivityCls.newInstance();
	Toast.makeText(this, app1Activity.toString(), Toast.LENGTH_LONG)
			.show();
} catch (Exception e) {
	throw new RuntimeException("Context not found");
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 4</h3>
<br />
<pre><code>SharedPreferences prefs = context1.getSharedPreferences("app1prefs", MODE_PRIVATE);
TextView view =  (TextView) findViewById(R.id.hello);
String shared = prefs.getString("shared_value", null);
if (shared == null) {
	view.setText("Failed to share!");
} else {
	view.setText(shared);
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Resources</h3>
<br />
<p><a href="http://source.android.com/tech/security/index.html" >Tech info on security</a></p>
<p><a href="http://groups.google.com/group/android-security-discuss" >Security user group</a></p>
<!-- ==================================================== -->
</article>
   
    </section>
  </body>
</html>

