<!DOCTYPE html>
<html>
  <head>
    <title>Android training - app in a day</title>
    <meta charset='utf-8'>
    <script src='../res/slides.js'></script>
  </head>
  <body style='display: none'>
    <section class='slides layout-regular template-default'>
    
<article>
<!-- ==================================================== -->

<h1>app in a day</h1>  
   
<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 1</h3>
<ul>
  <li>Create a new project with one activity DashboardActivity</li>
  <li>Run it</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 1</h3>
<ul>
  <li>Create a new android project and follow the instruction</li>
  <li>Create adv if you don't have an android device</li>
  <li>Deploy the app and run it</li>
</ul> 
   
<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 2</h3>
<ul>
  <li>Change layout of DashboardActivity activity</li>
  <li>Add a Button with a text "Search"</li>
  <li>Add an EditText</li>
  <li>Set a onClickListener in the Button</li>
  <li>Log the text of the EditText when the button is pressed</li>
</ul>
   
<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 2</h3>
<p>In main layout add EditText with id keyword</p>
<pre><code>&lt;EditText android:id="@+id/keyword"
  android:layout_width="fill_parent"
  android:layout_height="wrap_content" /&gt;
</code></pre>
<p>In main layout add Button with id submit</p>
<pre><code>&lt;Button
  android:id="@+id/submit"
  android:layout_width="fill_parent"
  android:layout_height="wrap_content" 
  android:text="@string/search"/&gt;
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 2</h3>
<p>Change the string to search</p>
<pre><code>&lt;string name="search"&gt;Search&lt;/string&gt;</code></pre>
<p>Add the click listener in the DashboardActivity and log the content of keyword</p>
<pre><code>final EditText editText = (EditText)findViewById(R.id.keyword);
  Button submit = (Button)findViewById(R.id.submit);
  submit.setOnClickListener(new OnClickListener() {
  public void onClick(View v) {
    Log.v("AppInADay", "keyword to search for is : " 
      + editText.getText().toString());
  }
});
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 3</h3>
<ul>
  <li>Add new activity SearchResultActivity</li>
  <li>On search submit open the new activity SearchResultActivity</li>
  <li>Pass the value contained in the EditText with the intent</li>
  <li>Show the keyword in a TextView in the new activity </li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 3</h3>
<p>Create new class SearchResultActivity and setContentView</p>
<pre><code>@Override
  public void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.main);
}</code></pre>

<p>Rename main.xml to dashboard_activity.xml </p>
<p>Copy dashboard_activity.xml as search_result_activity.xml and fix compilation problem</p>


<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 3</h3>
<p>Edit the layout to have an TextView</p>
<pre><code>&lt;TextView
  android:id="@+id/keyword"
  android:layout_width="fill_parent"
  android:layout_height="wrap_content" /&gt;
</code></pre>
<p>In the on click listener of the DashboardActivity add</p>
<pre><code>Intent i = new Intent(getApplicationContext(), 
  SearchResultActivity.class);
i.putExtra("keyword", editText.getText().toString());
startActivity(i);</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 3</h3>
<p>onCreate of the SearchResultActivity add :</li>
<pre><code>TextView keywordView = (TextView)findViewById(R.id.keyword);
String keyword = getIntent().getStringExtra("keyword");
keywordView.setText(keyword);</code></pre>
<p>Finally declare the activity in the manifest</p>
<pre><code>&lt;activity
  android:label="@string/app_name"
  android:name=".SearchResultActivity" &gt;
&lt;/activity&gt;</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 4</h3>
<ul>   
   <li>Transform the SearchResultActivity in a ListActivity</li>
   <li>Load the list from a simple List of strings</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 4</h3>
<p>Extend ListActivity instead of Activity, change onCreate and set the adapter with some data</p>
<pre><code>List&lt;String&gt; values = Arrays.asList("item 1","item 2","item 3");
ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(this,
R.layout.search_result_item, R.id.title, values);
setListAdapter(adapter);</code></pre>
<p>Modify search_result_activity.xml layout with ListView</p>
<pre><code>&lt;ListView
  android:id="@+android:id/list"
  android:layout_width="fill_parent"
  android:layout_height="wrap_content" /&gt;
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 4</h3>
<p>Create search_result_item.xml</p>   
<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android=
    "http://schemas.android.com/apk/res/android"
  android:layout_width="fill_parent"
  android:layout_height="fill_parent" &gt;
  &lt;TextView
    android:id="@+id/title"
    android:gravity="center"
    android:layout_width="fill_parent"
    android:layout_height="40dp" &gt;
  &lt;/TextView&gt;
&lt;/LinearLayout&gt;
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 5</h3>
<ul>   
   <li>Create a content provider</li>
   <li>Add some log in the implementation of crud operations</li>
   <li>Get a cursor from the SearchResultActivity</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 5</h3>
<p>Create SearchProvider that extends ContentProvider and implements all the methods</p>
<pre><code>@Override
public int delete(Uri arg0, String arg1, String[] arg2) {
  Log.v(TAG, "delete");
  return 0;
}
@Override
public String getType(Uri uri) {
  Log.v(TAG, "type");
  return null;
}
@Override
public Uri insert(Uri uri, ContentValues values) {
  Log.v(TAG, "insert");
return null;
}</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 5</h3>
<pre><code>@Override
  public boolean onCreate() {
  Log.v(TAG, "onCreate");
  return false;
}
@Override
public Cursor query(Uri uri, String[] projection, String selection,
    String[] selectionArgs, String sortOrder) {
  Log.v(TAG, "query");
  return null;
}
@Override
public int update(Uri uri, ContentValues values, String selection,
    String[] selectionArgs) {
  Log.v(TAG, "update");
  return 0;
}</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 5</h3>
<p>Declare the provider in the manifest</p>
<pre><code>&lt;provider android:name=".SearchProvider" 
android:authorities="com.novoda.appinaday" /&gt;
</code></pre>
<p>Make a query in the SearchResultActivity and verify logs</p>
<pre><code>Uri uri = Uri.parse("content://com.novoda.appinaday/results");
getContentResolver().query(uri, null, null, null, null);
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 6</h3>
<ul>   
   <li>Add a database</li>
   <li>Implement insert, delete and query</li>
   <li>Put some fixture data in the database</li>
   <li>Log the query in the SearchResultActivity</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 6</h3>
<p>Create a new class DatabaseHelper and extend SQLiteOpenHelper with version and name</p>
<pre><code>private static final String DATABASE_NAME = "appinaday.db";
private static final int DATABASE_VERSION = 1;
  
public DatabaseHelper(Context context) {
  super(context, DATABASE_NAME, null, DATABASE_VERSION);
}</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 6</h3>
<p>Implement the onCreate method and create the table and import some data</p>
<pre><code>db.execSQL("CREATE TABLE results" + 
  " (_id INTEGER PRIMARY KEY AUTOINCREMENT, title TEXT)");
db.execSQL("INSERT INTO results (title) VALUES (\"title 1\")");
db.execSQL("INSERT INTO results (title) VALUES (\"title 2\")");
db.execSQL("INSERT INTO results (title) VALUES (\"title 3\")");
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 6</h3>
<p>Add implementation of query to the content provider</p>
<pre><code>private DatabaseHelper databaseHelper;
@Override
public boolean onCreate() {
  databaseHelper = new DatabaseHelper(getContext());
  return false;
}
@Override
public Cursor query(Uri uri, String[] projection, String selection, 
    String[] selectionArgs, String sortOrder) {
  return databaseHelper.getReadableDatabase().query("results", 
      projection, selection, selectionArgs, null, null, sortOrder); 
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 6</h3>
<p>Use the cursor to provide results in the SearchResultActivity</p>
<pre><code>Uri uri = Uri.parse(
  "content://com.novoda.appinaday/results");
Cursor c = getContentResolver().query(uri, null, null, null, null);
List&lt;String&gt; values = new ArrayList&lt;String&gt;();
while (c.moveToNext()){
	values.add(c.getString(c.getColumnIndex("title")));
}
c.close();
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 6</h3>
<p>SimpleCursorAdapter instead of ArrayAdapter</p>
<pre><code>private static final String[] FROM = new String[] { "title" };
private static final int[] TO = new int[] { R.id.title };

@Override
public void onCreate(Bundle savedInstanceState) {
  super.onCreate(savedInstanceState);
  setContentView(R.layout.search_result_activity);

  Uri uri = Uri.parse("content://com.novoda.appinaday/results");
  Cursor c = getContentResolver().query(uri, null, null, null, null);
  setListAdapter(new SimpleCursorAdapter(this, 
    R.layout.search_result_item, c, FROM, TO));
}</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 7</h3>
<ul>   
   <li>Create an IntentService and run it before calling on search submit</li>
   <li>Load the results in the list activity only when the service send back broadcast</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 7</h3>
<p>Create a new class and extend SearchService and log the keyword</p>
<pre><code>public SearchService() {
  this("SearchService");
}
public SearchService(String name) {
  super(name);
}
@Override
protected void onHandleIntent(Intent intent) {
  String keyword = intent.getStringExtra("keyword");
  if (TextUtils.isEmpty(keyword)) {
    return;
  }  
  Log.v("AppInADay", "Search for : " + keyword);    
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 7</h3>
<p>We need an action for the service</p>
<pre><code>public static final String SEARCH_ACTION = 
  "com.novoda.appinaday.Search";</code></pre>
<p>Declare the service in the manifest</p>
<pre><code>&lt;service android:exported="true" android:name=".SearchService"&gt;
  &lt;intent-filter&gt;
    &lt;action android:name="com.novoda.appinaday.Search"/&gt;
  &lt;/intent-filter&gt;
&lt;/service&gt;
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 7</h3>
<p>Change a bit SearchResultActivity to call the service</p>
<pre><code>@Override
protected void onResume() {
  super.onResume();
  String keyword = getIntent().getStringExtra("keyword");
  Intent i = new Intent(SearchService.SEARCH_ACTION);
  i.putExtra("keyword", keyword);
  startService(i);
  //update();
}

private void update() {
  Uri uri = Uri.parse("content://com.novoda.appinaday/results");
  Cursor c = getContentResolver().query(uri, null, null, null, null);
  setListAdapter(new SimpleCursorAdapter(this, R.layout.search_result_item, c, FROM, TO));
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 7</h3>
<p>Run and check that the service runs and print the logs before implementing the next step</p>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 7</h3>
<p>Send the broadcast from the service to inform the activity that the service has finished</p>
<pre><code>public static final String END_SEARCH_ACTION 
  = "com.novoda.appinaday.EndSearch";
//...
Intent broadcastIntent = new Intent(END_SEARCH_ACTION);
sendBroadcast(broadcastIntent);
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 7</h3>
<p>Create a broadcast receiver in the SearchResultActivity</p>
<pre><code>private BroadcastReceiver serchCompletedReceiver 
    = new BroadcastReceiver() {
  @Override
  public void onReceive(Context paramContext, 
    Intent paramIntent) {
    update();
  }
};</code></pre>
<p>Note the update in onReceive</p>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 7</h3>
<p>Register the receiver in the SearchResultActivity</p>
<pre><code>@Override
protected void onResume() {
  super.onResume();
  IntentFilter filter = new IntentFilter(
    SearchService.END_SEARCH_ACTION);
  registerReceiver(serchCompletedReceiver, filter);
  
  //...start the service
}

@Override
protected void onPause() {
  unregisterReceiver(serchCompletedReceiver);
  super.onPause();
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 8</h3>
<ul>   
   <li>Execute http call to get the result</li>
   <li>Log all the parsed titles of the 
       http://ajax.googleapis.com/ajax/services/search/web?v=1.0&rsz=8&q=test</li>
   <li>Use the correct keyword coming from the DashboardActivity</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 8</h3>
<p>Add http call in the SearchService with HttpClient</p>
<pre><code>private void callGoogleSearch(String keyword) {
  try {
    String url = "http://ajax.googleapis.com/ajax/services"
      + "/search/web?v=1.0&rsz=8&q=" + keyword;
    HttpClient client = new DefaultHttpClient();
    HttpGet httpGet = new HttpGet(url);
    HttpResponse response = client.execute(httpGet);
    StatusLine statusLine = response.getStatusLine();
    int statusCode = statusLine.getStatusCode();
    if (statusCode == 200) {
      HttpEntity entity = response.getEntity();
      Log.v("SearchService", EntityUtils.toString(entity));
    }
  } catch (Exception e) {
  	throw new RuntimeException(e.getMessage());
  }}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 8</h3>
<p>Add INTERNET permission</p>
<pre><code>&lt;uses-permission android:name="android.permission.INTERNET" /&gt;</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 9</h3>
<ul>   
   <li>Parsed the response of the server to extract titles</li>
   <li>Log all the titles</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 9</h3>
<p>Add <a href="resources/gson-1.7.1.jar">gson jar</a> to the project libs and add it to the classpath</p>
<p>Prepare a stream and pass it to a parsing method</p>
<pre><code>...
if (statusCode == 200) {
  HttpEntity entity = response.getEntity();
  
  InputStream content = entity.getContent();
      InputStreamReader stream = new InputStreamReader(content);
  parse(stream);
...</code></pre>
<p>Remember to remove the Log of the entity content as it can be consumed only once!</p>
<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 9</h3>
<p>Considering the json</p>
<pre><code>{
  responseData: {
    results: [
      {
        GsearchResultClass: "GwebSearch",
        unescapedUrl: "http://test.com/",
        url: "http://test.com/",
        visibleUrl: "test.com",
        cacheUrl: "http://www.google.com/s...",
        title: "<b>Test</b>.com Web Based ...",
        titleNoFormatting: "Test.com Web Base...",
        content: "Easily Author and Administe.."
      },
  ...
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 9</h3>
<p>Navigate through the json until the result array</p>
<pre><code>JsonReader reader = new JsonReader(stream);
reader.beginObject();
reader.nextName();
reader.beginObject();
reader.nextName();
reader.beginArray();
JsonToken token = reader.peek();
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 9</h3>
<p>Iterate and log all the titles</p>
<pre><code>while (token != JsonToken.END_ARRAY
    && token != JsonToken.END_DOCUMENT) {
  if (token == JsonToken.BEGIN_OBJECT) {
    reader.beginObject();
  } else if (token == JsonToken.NAME) {
    String name = reader.nextName();
    if ("title".equals(name)) {
      Log.v("AppInADay", reader.nextString());
    } else {
      reader.skipValue();
    }
  } else if (token == JsonToken.END_OBJECT) {
    reader.endObject();
  }
  token = reader.peek();
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 10</h3>
<ul>   
   <li>Clean up the database of old results</li>
   <li>Insert all the new results</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 10</h3>
<p>Clean the result table before starting a new search</p>
<pre><code>Uri uri = Uri.parse(
  "content://com.novoda.appinaday/results");
getContentResolver().delete(uri, null, null);
</code></pre>
<p>Implement the delete method in the provider</p>
<pre><code>@Override
public int delete(Uri uri, String where, String[] selectionArgs) {
  return databaseHelper.getWritableDatabase().delete("results", 
	where, selectionArgs);
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Solution 10</h3>
<p>Add the insert during the parsing of the results</p>
<pre><code>Uri uri = Uri.parse("content://com.novoda.appinaday/results");
ContentValues cv = new ContentValues(1);
cv.put("title", reader.nextString());
getContentResolver().insert(uri, cv);
</code></pre>
<p>Implement the insert method in the provider</p>
<pre><code>@Override
public Uri insert(Uri uri, ContentValues values) {
  long id = databaseHelper.getWritableDatabase().insert(
    "results", null ,values);
  return Uri.withAppendedPath(uri, "" + id);
}
</code></pre>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Exercise 11</h3>
<p>Make the app better</p>
<ul>   
   <li>Have just one activity</li>
   <li>Add history of the search keywords</li>
   <li>Make it nice</li>
   <li>Add links and more information of the results</li>
   <li>Open the browser with the url when pressing an item</li>
   <li>...</li>
</ul>

<!-- ==================================================== -->
</article><!-- slide separator--><article>
<!-- ==================================================== -->

<h3>Notes</h3>
<ul>   
   <li>Queries on ui thread</li>
   <li>HttpClient initialised on every call</li>
   <li>Poor exception handling during the parsing</li>
   <li>Missing connection status</li>
   <li>...</li>
</ul>

<!-- ==================================================== -->
</article>

    </section>
  </body>
</html>